---
title: "Merging MOMS-PI dbGap Metadata"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Terminal Command: mount -t smbfs  //'rams;eid'@rams.adp.vcu.edu/som/shares/Biostatistics/Projects/MOMS-PI ~/local_folder_path/MOMS-PI


```{r cars}
rm(list=ls())
library(data.table)
library(tidyr)
library(dplyr)
library(stringr)
library(here)
library(phyloseq)
```

## Including Plots

You can also embed plots, for example:

```{r files, echo=FALSE}

#path to protected dbGap data location

local_path <- "~/Documents/MOMS-PI"# change me
local_path <- "~/MOMS-PI"# change me

path2 <- file.path(local_path,"71694", "PhenoGenotypeFiles", "RootStudyConsentSet_phs001523.MOMS_PI.v1.p1.c1.DS-PREG-COM-IRB-PUB-MDS", "PhenotypeFiles") 

load(here("data","stirrups_OTU.rda"))
load(here("data", "stirrups_samps.rda"))
physeq <- readRDS(here("data", "stirrups_phyloseq.RDS"))
newmoms <- rownames(meta_sub)
```

```{r Functions}
#Makes first row the column name and then deletes first row
#Input: Dataframe
#Output: Dataframe with one less row
header.true <- function(df) {
  names(df) <- as.character(unlist(df[1,]))
  df[-1,]
}
#Tests if any column is all NA
#Input: Dataframe
#Output: Nothing if no NA, otherwise outputs columns that are NA
na.test <-  function (x) {
  w <- sapply(x, function(x)all(is.na(x)))
  if (any(w)) {
    stop(paste("All NA in columns", paste(which(w), collapse=", ")))
  }
}
#Checks if df has any columns not in hope and updates to df to unique columns and a 'visit_ID' column
#Input: 2 Dataframes
#Output: Dataframe with unique columns
short.df <- function(df, hope) {
  ind <- which(names(df) %in% names(hope))
  visit <- which(names(df) == "visit_ID")
  count <- 0
  for (i in ind){
    i <- i - count
    if(i != (visit-count)){
      df <- df[,-i]
      count <- count + 1
    }
  }
  return(df)
}
```

```{r }
# Include specific file names that you want here:
# Add each file and merge to phyloseq object
multi <- read.table(file.path(path2, "phs001523.v1.pht007509.v1.p1.MOMS_PI_Sample.MULTI.txt"), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
multi <- header.true(multi)
check <- meta_sub[newmoms %in% multi$SAMPLE_ID,]
multi_cond <- multi[multi$SAMPLE_ID %in% newmoms,]
visit_ID <- str_split_fixed(multi_cond$SAMPLE_ID, "_MV1D", n = 2)[,1]
multi_cond["visit_ID"] <- c(visit_ID)

clinical <- read.table(file.path(path2, "phs001523.v1.pht007510.v1.p1.c1.phenotype_clinical.DS-PREG-COM-IRB-PUB-MDS.txt"), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
clinical <- header.true(clinical)
names(clinical)
clinical <- short.df(clinical, multi_cond)
add_meta <- merge(x = multi_cond, y = clinical, all.x = TRUE)

health_history <- read.table(file.path(path2, "phs001523.v1.pht007512.v1.p1.c1.phenotype_healthHistorySurvey.DS-PREG-COM-IRB-PUB-MDS.txt"), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
health_history <- header.true(health_history)
health_history <- short.df(health_history, add_meta)
add_meta <- merge(x = add_meta, y = health_history, all.x = TRUE)

na.test(add_meta)

#Merge to phyloseq object:
add_samps <- sample_data(add_meta)
new_physeq <- merge_phyloseq(physeq, add_samps)
<<<<<<< HEAD
=======
#need to be saved to Biostats server
>>>>>>> 600defea69c10f223ed6b8cc71fad6d3e6c905dc
#saveRDS(new_physeq, file = "stirrups_phyloseq_updated.RDS")
```


```{r }
filelist = list.files(path = path2, pattern = ".*.txt$")

init <- read.table(file.path(path2, filelist[9]), fill = TRUE, header = FALSE, sep = "", dec = ".")
init <- header.true(init)
names(init)

#See which from custom database are in the biostat server text file sample id's
check <- meta_sub[newmoms %in% init$SAMPLE_ID,] #2055 obs x 13 variables (so all samples in custom are captured)
samps <- init[init$SAMPLE_ID %in% newmoms,] #Create initial matrix for 2055 samples

#Read in second file
second <- read.table(file.path(path2, filelist[2]), fill = TRUE, header = FALSE, sep = "", dec = ".")
second <- header.true(second)
#Merge initial file and second file
comp_meta <- merge(samps, second)
#Create column for visit_ID as it is seen in most files and unique
visit_ID <- str_split_fixed(comp_meta$SAMPLE_ID, "_MV1D", n = 2)[,1]
comp_meta["visit_ID"] <- c(visit_ID)
#Read in first file
one <- read.table(file.path(path2, filelist[1]), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
one <- header.true(one)
#Merge updated file and first file
comp_meta <- merge(comp_meta,one)
#For loop that goes through remaining file, besides last file, and merges the files based on the visit ID
for (i in 3:7) {
  file <- read.table(file.path(path2, filelist[i]), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
  file <- header.true(file)
  file <- short.df(file, comp_meta) #Function to shorten file to just meaningful/unseen columns
  comp_meta <- merge(x = comp_meta, y = file, by = "visit_ID", all.x = TRUE)
}
#Merge last file
eight <- read.table(file.path(path2, filelist[8]), fill = TRUE, header = FALSE, sep = "\t", dec = ".")
eight <- header.true(eight)
comp_meta <- merge(x = comp_meta, y = eight, all.x = TRUE)
na.test(comp_meta) #Test if file has any columns with all NA values

#Merge into phyloseq
comp_samps <- sample_data(comp_meta)
comp_physeq <- merge_phyloseq(physeq, comp_samps)
<<<<<<< HEAD
=======
#have to be saved to Biostats server
>>>>>>> 600defea69c10f223ed6b8cc71fad6d3e6c905dc
#saveRDS(comp_physeq, file = "stirrups_phyloseq_completed.RDS")
```
